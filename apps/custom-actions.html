<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <title>Custom Actions</title>
    
    
    <link rel="stylesheet" href="../theme/bootstrap.min.css" />
    <link rel="stylesheet" href="../theme/pygments.css" />
    <link rel="stylesheet" href="../theme/main.css" />
    
    
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="../theme/jquery.min.js"></script>
    <script src="../theme/bootstrap.min.js"></script>
    
  </head>
  <body>
    <nav class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Nuvola Player Documentation</a>
    </div><!-- .navbar-header -->

    <div class="collapse navbar-collapse" id="navbar-collapse-1">
  <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../core.html">Core</a></li>
            <li class="dropdown">
              <a href="../apps.html" class="dropdown-toggle" data-toggle="dropdown">Service Integrations <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li class="divider"></li>
                <li class="dropdown-header">Basic</li>
                <li><a href="../apps.html">Introduction</a></li>
                <li><a href="../apps/api_reference.html">NuvolaKit 4 JavaScript API Reference</a></li>
                <li><a href="../apps/tutorial.html">Service Integration Tutorial</a></li>
                <li><a href="../apps/mediaplayer.html">Media Player Integration</a></li>
                <li><a href="../apps/guidelines.html">Service Integration Guidelines</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Advanced</li>
                <li><a href="../apps/url-filtering.html">URL Filtering (URL Sandbox)</a></li>
                <li><a href="../apps/configuration-and-session-storage.html">Configuration and session storage</a></li>
                <li><a href="../apps/initialization-and-preferences-forms.html">Initialization and Preferences Forms</a></li>
                <li><a href="../apps/variable-home-page-url.html">Web apps with a variable home page URL</a></li>
                <li><a href="../apps/custom-actions.html">Custom Actions</a></li>
                <li><a href="../apps/translations.html">Translations</a></li>
              </ul>
            </li>
          </ul>
</div><!-- .navbar-collapse -->
  </div>
</nav>
    
    <div class="container">
      <div class="row">
        
        
  <div class="col-sm-12">
      <div class="page-header text-center">
        <h1 id="top">Custom Actions</h1>
      </div>
  </div>
  <div class="col-md-2 col-lg-3 sidebar">
    
      <p><strong>Contents</strong></p>
      <div class="toc">
<ul>
<li><a href="#create-actions">Create Actions</a></li>
<li><a href="#show-actions-in-user-interface">Show Actions in User Interface</a></li>
<li><a href="#manage-actions">Manage Actions</a></li>
<li><a href="#respond-to-actions">Respond to Actions</a></li>
<li><a href="#keyboard-shortcuts">Keyboard Shortcuts</a></li>
<li><a href="#conditional-actions">Conditional Actions</a></li>
</ul>
</div>
    
    <p><strong>Download documentation</strong></p>

<p>You can download the whole documentation in HTML format as</p>
<ul>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc/archive/master.zip">Zip Archive</a></li>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc">Git Repository</a></li>
</ul>

<p><strong>Get source</strong></p>
<p>
  This documentation is built from the
  <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">doc directory</a>
  of the
  <a href="https://github.com/tiliado/nuvolaplayer">Nuvola Player repository</a>.
</p>
    <span class="backtotop"><a href="#top">↑ Back to top ↑</a></span>
  </div>
  <div class="col-sm-12 col-md-10 col-lg-9">
    <p>Actions API allows you to add custom actions alongside <a href="./api_reference.html#Nuvola.PlayerAction">player actions</a>.
Typical examples include thumbs up/down, like/love or star rating, but we don't want to limit your
fantasy.</p>
<h2 id="create-actions">Create Actions</h2>
<p>First of all, we define some constants with action names. The action name has to consist only
from letters, digits and dash. Then we create the actions in
<a href="./api_reference.html#Nuvola.Core%3A%3AInitAppRunner">Nuvola.Core::InitAppRunner</a> signal handler:</p>
<ul>
<li>We create a <strong>simple action</strong> <code>ACTION_ALERT</code> with method
    <a href="./api_reference.html#Nuvola.Actions.addAction">Nuvola.Actions.addAction</a> within action group <code>playback</code>,
    with scope <code>win</code> and label <code>Alert!</code>. Other parameters (mnemo_label, icon, keybinding, state)
    are null.</li>
<li>We create two <strong>toggle actions</strong> (on/off, checked/unchecked) <code>ACTION_THUMBS_UP</code> and
    <code>ACTION_THUMBS_DOWN</code> with the same method 
    <a href="./api_reference.html#Nuvola.Actions.addAction">Nuvola.Actions.addAction</a>, but we specify initial state to be
    <code>true</code> (on, checked).</li>
<li>We create one <strong>radio action</strong> (action with multiple options/states) <code>ACTION_RATING</code> with method
    <a href="./api_reference.html#Nuvola.Actions.addRadioAction">Nuvola.Actions.addRadioAction</a>. Options are specified
    by an array <code>ratingOptions</code> and the initial state is set to <code>0</code> (0 starts).</li>
</ul>
<p>Note that <a href="../apps/translations.html">translation function</a> alias <code>C_</code> is used mark short
translatable strings with context information ("Action") and <code>ngettext</code> for string with both
singular and plural forms.</p>
<pre class="codehilite"><code class="language-js">...
// Translations
var C_ = Nuvola.Translate.pgettext;
var ngettext = Nuvola.Translate.ngettext;
...
var ACTION_ALERT = "x-alert";
var ACTION_THUMBS_UP = "thumbs-up";
var ACTION_THUMBS_DOWN = "thumbs-down";
var ACTION_RATING = "rating";

...

var WebApp = Nuvola.$WebApp();

WebApp._onInitAppRunner = function(emitter)
{
    Nuvola.WebApp._onInitAppRunner.call(this, emitter);

    Nuvola.actions.addAction("playback", "win", ACTION_ALERT, C_("Action", "Alert!"),
        null, null, null, null);
    Nuvola.actions.addAction("playback", "win", ACTION_THUMBS_UP, C_("Action", "Thumbs up"),
        null, null, null, true);
    Nuvola.actions.addAction("playback", "win", ACTION_THUMBS_DOWN, C_("Action", "Thumbs down"),
        null, null, null, true);
    var ratingOptions = [];
    for (var stars = 0; stars &lt; 6; stars++)
        ratingOptions.push([
            stars, // stateId
            /// Star rating, {1} is a placeholder for a number 
            Nuvola.format(ngettext("Rating: {1} star", "Rating: {1} stars", stars), stars), // label
            null, // mnemo_label
            null, // icon
            null  // keybinding
            ]);
    Nuvola.actions.addRadioAction("playback", "win", ACTION_RATING, 0, ratingOptions);
}

...</code></pre>
<div class="panel panel-danger"><p class="panel-heading">Global window object not available</p><div class="panel-body">
<p>The <a href="./api_reference.html#Nuvola.Core%3A%3AInitAppRunner">Nuvola.Core::InitAppRunner</a> signal is
executed in a pure JavaScript environment without
<a href="https://developer.mozilla.org/en/docs/Web/API/Window">Window object</a>.
Use <a href="./api_reference.html#Nuvola.log">Nuvola.log()</a> to print logging and debugging messages to terminal
instead of <a href="https://developer.mozilla.org/en-US/docs/Web/API/console.log">console.log()</a>.</p>
</div></div>
<h2 id="show-actions-in-user-interface">Show Actions in User Interface</h2>
<p>Nuvola Player is happy about the new actions, but it has no idea what to do with them. Let's
add these actions to the media player component with method
<a href="./api_reference.html#Nuvola.MediaPlayer.addExtraActions">Nuvola.MediaPlayer.addExtraActions</a>. Note that we have
to add one identifier for each option/state of a radio action, the indentifier consists of the
action name and the option id separated by two colons <code>::</code>.</p>
<pre class="codehilite"><code class="language-js">...

var player = Nuvola.$object(Nuvola.MediaPlayer);

...

var WebApp = Nuvola.$WebApp();

...

WebApp._onPageReady = function()
{
    var actions = [ACTION_ALERT, ACTION_THUMBS_UP, ACTION_THUMBS_DOWN];
    for (var i=0; i &lt;= 5; i++)
        actions.push(ACTION_RATING + "::" + i);

    player.addExtraActions(actions);
    this.update();
}

...</code></pre>
<p>The media player component than orders Nuvola Player to show the actions in user interface:</p>
<p><img alt="Custom actions" src="../images/guide/custom_actions.png"/></p>
<h2 id="manage-actions">Manage Actions</h2>
<p>As you can see in the previous picture, <em>new actions are disabled/insensitive by default</em>.
Your task is to examine the web page whether the a particular action is available/enabled
and to extract state of toggle and radio actions. Then update enabled flag with method
<a href="./api_reference.html#Nuvola.Actions.updateEnabledFlag">Nuvola.actions.updateEnabledFlag</a> or
<a href="./api_reference.html#Nuvola.Actions.updateEnabledFlags">Nuvola.actions.updateEnabledFlags</a> and
state of radio and toggle actions with method 
<a href="./api_reference.html#Nuvola.Actions.updateState">Nuvola.actions.updateState</a> or
<a href="./api_reference.html#Nuvola.Actions.updateStates">Nuvola.actions.updateStates</a>.</p>
<pre class="codehilite"><code class="language-js">...

WebApp.update = function()
{
    ...

    // Extract whether the action is enabled and its state from a web page
    var actionsEnabled = {};
    var actionsStates = {};

    actionsEnabled[ACTION_ALERT] = true;

    actionsEnabled[ACTION_THUMBS_UP] = true;
    actionsStates[ACTION_THUMBS_UP] = true; // on/checked

    actionsEnabled[ACTION_THUMBS_DOWN] = true;
    actionsStates[ACTION_THUMBS_DOWN] = false; // off/unchecked

    actionsEnabled[ACTION_RATING] = true;
    actionsStates[ACTION_RATING] = 3; // three stars

    // Compare with previous values and update if necessary
    Nuvola.actions.updateEnabledFlags(actionsEnabled);
    Nuvola.actions.updateStates(actionsStates);

    ...
}

...</code></pre>
<p><img alt="Custom actions - enabled" src="../images/guide/custom_actions_enabled.png"/></p>
<h2 id="respond-to-actions">Respond to Actions</h2>
<p>The final step is to write handlers for the new actions similarly like for
<a href="./api_reference.html#Nuvola.PlayerAction">player actions</a>: extend <code>WebApp._onActionActivated</code> method
from <a href="../apps/tutorial.html">tutorial</a>.</p>
<pre class="codehilite"><code class="language-js">...

WebApp._onActionActivated = function(emitter, name, param)
{
    switch (name)
    {
    /* Base media player actions */
    case PlayerAction.TOGGLE_PLAY:
        ...
        break;
    case PlayerAction.PLAY:
        ...
        break;
    case PlayerAction.PAUSE:
    case PlayerAction.STOP:
        ...
        break;
    case PlayerAction.PREV_SONG:
        ...
        break;
    case PlayerAction.NEXT_SONG:
        ...
        break;

    /* Custom actions */
    case ACTION_ALERT:
        alert("Alert!");
        break;
    case ACTION_THUMBS_UP:
        Nuvola.clickOnElement(document.getElementById("thumbs-up"));
        break;
    case ACTION_THUMBS_DOWN:
        Nuvola.clickOnElement(document.getElementById("thumbs-down"));
        break;
    case ACTION_RATING:
        // param contains action's state, i.e. number of stars
        Nuvola.clickOnElement(document.getElementById("star-" + param));
        break;
    }
}

...</code></pre>
<p><img alt="Custom action - Alert!" src="../images/guide/custom_action_alert.png"/></p>
<div class="panel panel-info"><p class="panel-heading">Implementation detail</p><div class="panel-body">
<p><a href="./api_reference.html#Nuvola.PlayerAction">Player actions</a> are created by
<a href="./api_reference.html#Nuvola.MediaPlayer">Nuvola.MediaPlayer</a> with the same API as described here .</p>
</div></div>
<h2 id="keyboard-shortcuts">Keyboard Shortcuts</h2>
<p>Users can assign keyboard shortcuts to custom actions ;-)</p>
<p><img alt="Custom action - Keyboard shortcuts" src="../images/guide/custom_actions_keyboard_shortcuts.png"/></p>
<h2 id="conditional-actions">Conditional Actions</h2>
<p>It might sometimes happen that some actions make sense only in a certain user configuration. For
example, Google Play Music offers only thumbs up/down rating for songs by default, but users can
turn on five-star ratting in Music Labs. The following code detects which rating type is supported
and adds actions accordingly.</p>
<pre class="codehilite"><code class="language-js">var THUMBS_ACTIONS = [ACTION_THUMBS_UP, ACTION_THUMBS_DOWN];
var STARS_ACTIONS = [];
for (var i=0; i &lt;= 5; i++)
    STARS_ACTIONS.push(ACTION_RATING + "::" + i);

...

var WebApp = Nuvola.$WebApp();

...

WebApp.getThumbs = function()
{
    var elm = document.querySelector("#player-right-wrapper .thumbs.rating-container");
    return [elm, elm.childNodes[0], elm.childNodes[1]];
}

WebApp.getStars = function()
{
    return document.querySelector("#player-right-wrapper .stars.rating-container");
}

WebApp.update = function()
{
    ...

    // null = disabled; true/false toggled on/off
    var thumbsUp, thumbsDown;
    try
    {
        var thumbs = this.getThumbs();
        if (thumbs[0].style.visibility == "hidden")
        {
            thumbsUp = thumbsDown = null;
        }
        else
        {
            this.toggleThumbRating(true);
            thumbsUp = thumbs[1].className == "selected";
            thumbsDown = thumbs[2].className == "selected";
        }
    }
    catch (e)
    {
        thumbsUp = thumbsDown = null;
    }

    // null = disabled
    var starRating;
    try
    {
        var stars = this.getStars();
        if (stars.style.visibility == "hidden")
        {
            starRating = null;
        }
        else
        {
            this.toggleStarRating(true);
            starRating = stars.childNodes[0].getAttribute("data-rating") * 1;
        }
    }
    catch (e)
    {
        starRating = null;
    }

    ...
}

WebApp.toggleStarRating = function(enabled)
{
    if (enabled &amp;&amp; this.starRatingEnabled !== true)
    {
        player.addExtraActions(STARS_ACTIONS);
        this.starRatingEnabled = true;
    }
}

WebApp.toggleThumbRating = function(enabled)
{
    if (enabled &amp;&amp; this.thumbRatingEnabled !== true)
    {
        player.addExtraActions(THUMBS_ACTIONS);
        this.thumbRatingEnabled = true;
    }
}</code></pre>

    <div class="footer">
  <hr />
  <div class="panel panel-primary">
    <p class="panel-heading">
      Questions? Feedback?
    </p>
    <div class="panel-body">
      <p>
        Having trouble? We'd like to help!
      </p>
      <ul>
        <li>Search for information in the archives of
          <a href="https://groups.google.com/d/forum/nuvola-player-devel">the nuvola-player-devel
          mailing list</a>, or post a question.
        </li>
        <li>
          If you notice errors with this documentation, please
          <a href="https://github.com/tiliado/nuvolaplayer/issues">open a ticket and let us
          know</a>! Please only use the ticket tracker for criticisms and improvements on the docs.
        </li>
      </ul>
    </div>
  </div>
  <hr />
  <p class="text-center">
    Generated by <a href="http://getpelican.com/">Pelican</a>.
    Get <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">source code</a>.
    Uses <a href="http://getbootstrap.com/">Bootstrap</a> theme
    <a href="http://bootswatch.com/united/">United</a>.
  </p>
</div>
  </div> 

      </div>
    </div>
  </body>
</html>
