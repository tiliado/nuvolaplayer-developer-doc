<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <title>Media Player Integration</title>
    
    
    <link rel="stylesheet" href="../theme/bootstrap.min.css" />
    <link rel="stylesheet" href="../theme/pygments.css" />
    <link rel="stylesheet" href="../theme/main.css" />
    
    
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="../theme/jquery.min.js"></script>
    <script src="../theme/bootstrap.min.js"></script>
    
  </head>
  <body>
    <nav class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Nuvola Player Documentation</a>
    </div><!-- .navbar-header -->

    <div class="collapse navbar-collapse" id="navbar-collapse-1">
  <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../core.html">Core</a></li>
            <li class="dropdown">
              <a href="../apps.html" class="dropdown-toggle" data-toggle="dropdown">Service Integrations <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li class="divider"></li>
                <li class="dropdown-header">Basic</li>
                <li><a href="../apps.html">Introduction</a></li>
                <li><a href="../apps/api_reference.html">NuvolaKit 4 JavaScript API Reference</a></li>
                <li><a href="../apps/tutorial.html">Service Integration Tutorial</a></li>
                <li><a href="../apps/mediaplayer.html">Media Player Integration</a></li>
                <li><a href="../apps/screenshots.html">Web View Snapshot</a></li>
                <li><a href="../apps/guidelines.html">Service Integration Guidelines</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Advanced</li>
                <li><a href="../apps/url-filtering.html">URL Filtering (URL Sandbox)</a></li>
                <li><a href="../apps/configuration-and-session-storage.html">Configuration and session storage</a></li>
                <li><a href="../apps/initialization-and-preferences-forms.html">Initialization and Preferences Forms</a></li>
                <li><a href="../apps/variable-home-page-url.html">Web apps with a variable home page URL</a></li>
                <li><a href="../apps/custom-actions.html">Custom Actions</a></li>
                <li><a href="../apps/translations.html">Translations</a></li>
              </ul>
            </li>
          </ul>
</div><!-- .navbar-collapse -->
  </div>
</nav>
    
    <div class="container">
      <div class="row">
        
        
  <div class="col-sm-12">
      <div class="page-header text-center">
        <h1 id="top">Media Player Integration</h1>
      </div>
  </div>
  <div class="col-md-2 col-lg-3 sidebar">
    
      <p><strong>Contents</strong></p>
      <div class="toc">
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#metadata">Metadata</a></li>
<li><a href="#integration-script">Integration Script</a><ul>
<li><a href="#media-player-skeleton">Media player skeleton</a></li>
<li><a href="#interesting-elements">Interesting elements</a></li>
<li><a href="#playback-state">Playback state</a></li>
<li><a href="#track-details">Track details</a></li>
<li><a href="#media-player-actions">Media Player Actions</a></li>
<li><a href="#progress-bar">Progress bar</a></li>
<li><a href="#volume-management">Volume management</a></li>
<li><a href="#repeat-status">Repeat Status</a></li>
<li><a href="#shuffle-status">Shuffle Status</a></li>
<li><a href="#track-rating">Track Rating</a></li>
<li><a href="#custom-actions">Custom Actions</a></li>
</ul>
</li>
</ul>
</div>
    
    <p><strong>Download documentation</strong></p>

<p>You can download the whole documentation in HTML format as</p>
<ul>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc/archive/master.zip">Zip Archive</a></li>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc">Git Repository</a></li>
</ul>

<p><strong>Get source</strong></p>
<p>
  This documentation is built from the
  <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">doc directory</a>
  of the
  <a href="https://github.com/tiliado/nuvolaplayer">Nuvola Player repository</a>.
</p>
    <span class="backtotop"><a href="#top">↑ Back to top ↑</a></span>
  </div>
  <div class="col-sm-12 col-md-10 col-lg-9">
    
<p>Historically, Nuvola Apps Runtime (previously known as Nuvola Player) has a great support for media players and
offers a high level API for Media Player Integration.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Before continuing, make sure you are familiar with following topics:</p>
<ul>
<li><a href="tutorial.html">Service Integration Tutorial</a>: Generic information how to set up Nuvola ADK, create a basic skeleton of your
    script and open web inspector tools.</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model">Document Object Model</a>: Methods how to extract metadata from a web page, e.g.
  <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementById">document.getElementById</a>,
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document.getElementsByName">document.getElementsByName</a>,
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementsByClassName">document.getElementsByClassName</a>,
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementsByTagName">document.getElementsByTagName</a>,
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.querySelector">document.querySelector</a>,
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.querySelectorAll">document.querySelectorAll</a>.</li>
</ul>
<h2 id="metadata">Metadata</h2>
<p>Media player scripts generally contain these metadata:</p>
<ul>
<li><code>"categories": "AudioVideo;Audio;"</code> - for the launcher to be shown among audio &amp; video applications</li>
<li><code>"requirements": "Feature[Flash]"</code> - if your web app requires Flash plugin for media playback</li>
<li><code>"requirements": "Codec[MP3]"</code> - if your web app requires HTML5 Audio with MP3 codec for media playback</li>
<li><code>"requirements": "Feature[MSE] Codec[MP3]"</code> - if your web app requires HTML5 Media Source Extension (MSE)
    with MP3 codec for media playback</li>
</ul>
<h2 id="integration-script">Integration Script</h2>
<h3 id="media-player-skeleton">Media player skeleton</h3>
<p>Save the code bellow as a <code>integrate.js</code> file. It performs following actions:</p>
<ul>
<li>Creates new <code>Nuvola.MediaPlayer</code> component.</li>
<li>Creates new <code>WebApp</code> object.</li>
<li>Initializes WebWorker process to call <code>_onPageReady</code> callback when page is loaded.</li>
<li>Creates <code>update()</code> loop.</li>
<li>Connect handler for actions.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="s1">'use strict'</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Nuvola</span><span class="p">)</span> <span class="p">{</span>

<span class="c1">// Create media player component</span>
<span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">$object</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">MediaPlayer</span><span class="p">)</span>

<span class="c1">// Handy aliases</span>
<span class="kd">var</span> <span class="nx">PlaybackState</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlaybackState</span>
<span class="kd">var</span> <span class="nx">PlayerAction</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerAction</span>

<span class="c1">// Create new WebApp prototype</span>
<span class="kd">var</span> <span class="nx">WebApp</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">$WebApp</span><span class="p">()</span>

<span class="c1">// Initialization routines</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onInitWebWorker</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onInitWebWorker</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">'interactive'</span> <span class="o">||</span> <span class="nx">state</span> <span class="o">===</span> <span class="s1">'complete'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_onPageReady</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_onPageReady</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Page is ready for magic</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Connect handler for signal ActionActivated</span>
    <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'ActionActivated'</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>

    <span class="c1">// Start update routine</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Extract data from the web page</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// Schedule the next update</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Handler of playback actions</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

<span class="p">})(</span><span class="k">this</span><span class="p">)</span>  <span class="c1">// function (Nuvola)</span>
</pre></div>
</td></tr></table>
<h3 id="interesting-elements">Interesting elements</h3>
<p>It might be useful to create a mapping of interesting web page elements to reference them later easily.
This code snippet first creates mapping of the elements, then removes those with the <code>disabled</code> attribute,
and finally splits the combined play/pause button.</p>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">()</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_getElements</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Interesting elements</span>
  <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">play</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'pp'</span><span class="p">),</span>
    <span class="nx">pause</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">next</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'next'</span><span class="p">),</span>
    <span class="nx">prev</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'prev'</span><span class="p">),</span>
    <span class="nx">repeat</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'repeat'</span><span class="p">),</span>
    <span class="nx">shuffle</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'shuffle'</span><span class="p">),</span>
    <span class="nx">progressbar</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'progressbar'</span><span class="p">),</span>
    <span class="nx">volumebar</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'volume-bar'</span><span class="p">),</span>
    <span class="nx">repeat</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'repeat'</span><span class="p">),</span>
    <span class="nx">shuffle</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'shuffle'</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// Ignore disabled buttons</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">elms</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">elms</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">elms</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">disabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">elms</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Distinguish between play and pause action</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span> <span class="o">&amp;&amp;</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">.</span><span class="nx">firstChild</span> <span class="o">&amp;&amp;</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'pause'</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">elms</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">play</span>
    <span class="nx">elms</span><span class="p">.</span><span class="nx">play</span> <span class="o">=</span> <span class="kc">null</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">elms</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Interesting elements" src="../images/guide/interesting_elements.png"/></p>
<h3 id="playback-state">Playback state</h3>
<p>Looking at the web page, can use the state of the combined play/pause button to figure out playback state.
Playback states are defined in an enumeration <a href="./api_reference.html#Nuvola.PlaybackState">Nuvola.PlaybackState</a> and set by method
<a href="./api_reference.html#Nuvola.MediaPlayer.setPlaybackState">player.setPlaybackState()</a>.</p>
<div class="codehilite"><pre><span></span><span class="p">...</span>
<span class="kd">var</span> <span class="nx">PlaybackState</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlaybackState</span>
<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>

  <span class="kd">var</span> <span class="nx">state</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">PLAYING</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">PAUSED</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span>
  <span class="p">}</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setPlaybackState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Playback state" src="../images/guide/playback_state.png"/></p>
<h3 id="track-details">Track details</h3>
<p>In the demo player, track details are mostly available as a plain text content of the respective elements. We can use
<a href="./api_reference.html#Nuvola.queryText">Nuvola.queryText()</a> utility function to do that. The album art is a bit more complicated
as it is available as the <code>src</code> attribute and the address is not absolute. We can use
<a href="./api_reference.html#Nuvola.queryAttribute">Nuvola.queryAttribute()</a> to obtain the content of the <code>src</code> attribute and a custom
callback to convert the relative URL to the absolute one. Finally, we pass
track details to method <a href="./api_reference.html#Nuvola.MediaPlayer.setTrack">player.setTrack()</a>.</p>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>

  <span class="kd">var</span> <span class="nx">track</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">title</span><span class="o">:</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#track-title'</span><span class="p">),</span>
      <span class="nx">artist</span><span class="o">:</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#track-artist'</span><span class="p">),</span>
      <span class="nx">album</span><span class="o">:</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#track-album'</span><span class="p">),</span>
      <span class="nx">artLocation</span><span class="o">:</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryAttribute</span><span class="p">(</span><span class="s1">'#track-cover'</span><span class="p">,</span> <span class="s1">'src'</span><span class="p">,</span> <span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span>
        <span class="nx">src</span> <span class="o">?</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">src</span> <span class="o">:</span> <span class="kc">null</span>
      <span class="p">)),</span>
    <span class="p">}</span>

  <span class="nx">player</span><span class="p">.</span><span class="nx">setTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">)</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Track details" src="../images/guide/track_details.png"/></p>
<h3 id="media-player-actions">Media Player Actions</h3>
<p>The second responsibility of a service integration is to <strong>manage media player actions</strong>:</p>
<ol>
<li>Set which actions are enabled.</li>
<li>Invoke the actions when they are activated.</li>
</ol>
<p>The first part is done via calls <a href="./api_reference.html#Nuvola.MediaPlayer.setCanPause">player.setCanPause()</a>,
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanPlay">player.setCanPlay()</a>,
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanGoPrev">player.setCanGoPrev()</a> and
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanGoNext">player.setCanGoNext()</a>.
We can take advantage of the <code>WebApp._getElements()</code> utility functions defined earlier. It contains only buttons that
are available and not disabled.</p>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">()</span>
  <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanGoPrev</span><span class="p">(</span><span class="o">!!</span><span class="nx">elms</span><span class="p">.</span><span class="nx">prev</span><span class="p">)</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanGoNext</span><span class="p">(</span><span class="o">!!</span><span class="nx">elms</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanPlay</span><span class="p">(</span><span class="o">!!</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">)</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanPause</span><span class="p">(</span><span class="o">!!</span><span class="nx">elms</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Playback actions" src="../images/guide/playback_actions.png"/></p>
<p>To handle playback actions defined in an enumeration <a href="./api_reference.html#Nuvola.PlayerAction">PlayerAction</a>,
it is necessary to connect to <a href="./api_reference.html#Nuvola.Actions%3A%3AActionActivated">Actions::ActionActivated signal</a>.
You can use a convenient function <a href="./api_reference.html#Nuvola.clickOnElement">Nuvola.clickOnElement()</a> to
simulate clicking.</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">PlayerAction</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerAction</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Connect handler for signal ActionActivated</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'ActionActivated'</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>

  <span class="c1">// Start update routine</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">()</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">TOGGLE_PLAY</span><span class="o">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PLAY</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">play</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PAUSE</span><span class="o">:</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">STOP</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">pause</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PREV_SONG</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">prev</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">NEXT_SONG</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span>
      <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="panel panel-danger"><p class="panel-heading">Always test playback actions</p><div class="panel-body">
<p>You should click action buttons in the developer's sidebar to be sure they are working as expected.</p>
</div></div>
<h3 id="progress-bar">Progress bar</h3>
<p>Since <strong>Nuvola 4.5</strong>, it is also possible to integrate progress bar. In order to extract track length and position,
use these API calls:</p>
<ul>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setTrack">MediaPlayer.setTrack</a> supports <code>track.length</code> property, which holds track
    length either as a string 'mm:ss' or number of microseconds.</li>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setTrackPosition">MediaPlayer.setTrackPosition</a> is used to update track position.</li>
<li><a href="./api_reference.html#Nuvola.parseTimeUsec">Nuvola.parseTimeUsec</a> can be used to convert track length string (e.g. '2:35')
    into the number of microseconds. <a href="./api_reference.html#Nuvola.MediaPlayer.setTrack">MediaPlayer.setTrack</a> does that automatically
    for the <code>track.length</code> property.</li>
</ul>
<p>The necessary information is available as a plain text in the Demo player, so we can use
<a href="./api_reference.html#Nuvola.queryText">Nuvola.queryText()</a> utility function for that.</p>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">track</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">...</span>
  <span class="nx">track</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#timetotal'</span><span class="p">)</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">)</span>
  <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setTrackPosition</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#timeelapsed'</span><span class="p">))</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p>If you wish to let user change track position, use this API:</p>
<ul>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setCanSeek">MediaPlayer.setCanSeek</a> is used to enable/disable remote seek.</li>
<li>Then the <a href="./api_reference.html#Nuvola.PlayerAction">PlayerAction.SEEK</a> is emitted whenever a remote seek is requested.
    The action parameter contains a track position in microseconds.</li>
<li>You may need to use <a href="./api_reference.html#Nuvola.clickOnElement">Nuvola.clickOnElement</a> with coordinates to trigger a click
    event at the position of progress bar corresponding to the track position,
    e.g. <code>Nuvola.clickOnElement(progressBar, param/Nuvola.parseTimeUsec(trackLength), 0.5)</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanSeek</span><span class="p">(</span><span class="nx">state</span> <span class="o">!==</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span> <span class="o">&amp;&amp;</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">progressbar</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">()</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">SEEK</span><span class="o">:</span>
        <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">parseTimeUsec</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryText</span><span class="p">(</span><span class="s1">'#timetotal'</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">param</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">param</span> <span class="o">&lt;=</span> <span class="nx">total</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">progressbar</span><span class="p">,</span> <span class="nx">param</span> <span class="o">/</span> <span class="nx">total</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">break</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>
</pre></div>
<p><img alt="Playback time" src="../images/guide/progress_bar.png"/></p>
<h3 id="volume-management">Volume management</h3>
<p>Since <strong>Nuvola 4.5</strong>, it is also possible to integrate volume management. In order to extract volume, use
<a href="./api_reference.html#Nuvola.MediaPlayer.updateVolume">MediaPlayer.updateVolume</a> with the parameter in range 0.0-1.0 (i.e. 0-100%).</p>
<p>The volume is stored as an <code>aria-valuenow</code> attribute in the demo app, so we can use
<a href="./api_reference.html#Nuvola.queryAttribute">Nuvola.queryAttribute()</a> for that.</p>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">updateVolume</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">queryAttribute</span><span class="p">(</span><span class="s1">'#volume-mark'</span><span class="p">,</span> <span class="s1">'aria-valuenow'</span><span class="p">,</span> <span class="p">(</span><span class="nx">volume</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">volume</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p>If you wish to let user change volume, use this API:</p>
<ul>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setCanChangeVolume">MediaPlayer.setCanChangeVolume</a> is used to enable/disable remote
    volume management.</li>
<li>Then the <a href="./api_reference.html#Nuvola.PlayerAction">PlayerAction.CHANGE_VOLUME</a> is emitted whenever a remote volume change
    requested. The action parameter contains new volume as a double value in range 0.0-1.0.</li>
<li>You may need to use <a href="./api_reference.html#Nuvola.clickOnElement">Nuvola.clickOnElement</a> with coordinates to trigger a click
    event at the position of volume bar corresponding to the desired volume,
    e.g. <code>Nuvola.clickOnElement(volumeBar, param, 0.5)</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanChangeVolume</span><span class="p">(</span><span class="o">!!</span><span class="nx">elms</span><span class="p">.</span><span class="nx">volumebar</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elms</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">()</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">CHANGE_VOLUME</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">volumebar</span><span class="p">,</span> <span class="nx">param</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>
</pre></div>
<p><img alt="Playback volume" src="../images/guide/volume_management.png"/></p>
<h3 id="repeat-status">Repeat Status</h3>
<p>Since <strong>Nuvola 4.12.86</strong>, it is possible to integrate the <strong>repeat status</strong>.</p>
<ul>
<li>It is implemented as an action <a href="./api_reference.html#Nuvola.PlayerAction.REPEAT">PlayerAction.REPEAT</a> with three states:
    <a href="./api_reference.html#Nuvola.PlayerRepeat.NONE">PlayerRepeat.NONE</a> (default, don't repeat),
    <a href="./api_reference.html#Nuvola.PlayerRepeat.TRACK">PlayerRepeat.TRACK</a> (repeat a single track), and
    <a href="./api_reference.html#Nuvola.PlayerRepeat.PLAYLIST">PlayerRepeat.PLAYLIST</a> (repeat the whole playlist).</li>
<li>Use <a href="./api_reference.html#Nuvola.Actions.updateEnabledFlag">Actions.updateEnabledFlag</a> to enable the action
    and <a href="./api_reference.html#Nuvola.Actions.updateState">Actions.updateState</a> to update the current state.</li>
<li>The <a href="./api_reference.html#Nuvola.PlayerAction">PlayerAction.REPEAT</a> is emitted whenever the repeat status is changed remotely.
    The parameter is the new repeat status.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">_getRepeat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">().</span><span class="nx">repeat</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'ic_repeat_one_48px.svg'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerRepeat</span><span class="p">.</span><span class="nx">TRACK</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'btn-info'</span><span class="p">)</span> <span class="o">?</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerRepeat</span><span class="p">.</span><span class="nx">PLAYLIST</span> <span class="o">:</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerRepeat</span><span class="p">.</span><span class="nx">NONE</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_setRepeat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">repeat</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_getRepeat</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">repeat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">().</span><span class="nx">repeat</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">repeat</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getRepeat</span><span class="p">()</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateEnabledFlag</span><span class="p">(</span><span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">REPEAT</span><span class="p">,</span> <span class="nx">repeat</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">REPEAT</span><span class="p">,</span> <span class="nx">repeat</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">REPEAT</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_setRepeat</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span>
      <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Repeat tracks" src="../images/guide/tracks_repeat.png"/></p>
<h3 id="shuffle-status">Shuffle Status</h3>
<p>Since <strong>Nuvola 4.12.86</strong>, it is possible to integrate the <strong>shuffle status</strong>.</p>
<ul>
<li>It is implemented as an action <a href="./api_reference.html#Nuvola.PlayerAction.SHUFFLE">PlayerAction.SHUFFLE</a> with two states:
    <code>true</code> (shuffle tracks) and <code>false</code> (do not shuffle).</li>
<li>Use <a href="./api_reference.html#Nuvola.Actions.updateEnabledFlag">Actions.updateEnabledFlag</a> to enable the action
    and <a href="./api_reference.html#Nuvola.Actions.updateState">Actions.updateState</a> to update the current state.</li>
<li>The <a href="./api_reference.html#Nuvola.PlayerAction.SHUFFLE">PlayerAction.SHUFFLE</a> is emitted whenever the shuffle status is
    changed remotely. The parameter is the new shuffle status.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">_getShuffle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getElements</span><span class="p">().</span><span class="nx">shuffle</span>
  <span class="k">return</span> <span class="nx">elm</span> <span class="o">?</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'btn-info'</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">shuffle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getShuffle</span><span class="p">()</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateEnabledFlag</span><span class="p">(</span><span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">SHUFFLE</span><span class="p">,</span> <span class="nx">shuffle</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">SHUFFLE</span><span class="p">,</span> <span class="o">!!</span><span class="nx">shuffle</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">SHUFFLE</span><span class="o">:</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elms</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">)</span>
      <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Shuffle tracks" src="../images/guide/tracks_shuffle.png"/></p>
<h3 id="track-rating">Track Rating</h3>
<p>Since <strong>Nuvola 3.1</strong>, it is also possible to integrate track rating. One of consumers of this metadata is
<a href="https://extensions.gnome.org/extension/55/media-player-indicator/">GNOME Shell Media Player extension</a>, for example:</p>
<p><img alt="Example of MPRIS rating" src="../images/guide/example_mpris_rating.png"/></p>
<p>In order to provide users with the current rating state, use these API calls:</p>
<ul>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setTrack">MediaPlayer.setTrack()</a> method accepts <code>track.rating</code> property, which holds
    track rating as a number in range from <code>0.0</code> to <code>1.0</code> as in
    <a href="https://www.freedesktop.org/wiki/Specifications/mpris-spec/metadata/#index22h4">the MPRIS/xesam specification</a>.</li>
<li><a href="./api_reference.html#Nuvola.MediaPlayer.setCanRate">MediaPlayer.setCanRate()</a> controls whether
    it is allowed to change rating remotely or not.</li>
<li><a href="./api_reference.html#Nuvola.MediaPlayer%3A%3ARatingSet">MediaPlayer::RatingSet</a> is emitted when rating is changed remotely.</li>
</ul>
<p>It's up to you to decide <strong>how to map the double value to the rating system of your web app</strong>.
Here are some suggestions:</p>
<ul>
<li><strong>Percentage rating</strong> is the simplest case mapping the range <code>0.0-1.0</code> to percentage 0%-100%.</li>
<li><strong>Five-star rating</strong> may calculate the number of stars as <code>stars = rating / 5.0</code>.</li>
<li><strong>Thumb up/down rating</strong> is a bit tricky. You can use rating <code>0.2</code> for thumb down and <code>1.0</code> for thumb up in the
    <code>track.rating</code> property and interpret rating &lt;= <code>0.41</code> (0-2 stars) as thumb down and rating &gt;= <code>0.79</code> (4-5 stars)
    as thumb up in the <code>RatingSet</code> signal handler.</li>
</ul>
<p>The demo app supports five-star rating:</p>
<div class="codehilite"><pre><span></span><span class="p">...</span>

<span class="c1">// Page is ready for magic</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Connect handler for signal ActionActivated</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'ActionActivated'</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>

  <span class="nx">player</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'RatingSet'</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>

  <span class="c1">// Start update routine</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Extract data from the web page</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">track</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="p">...</span>

  <span class="c1">// Parse rating</span>
  <span class="kd">var</span> <span class="nx">rating</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'rating'</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">stars</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">stars</span> <span class="o">&lt;</span> <span class="nx">rating</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">stars</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">stars</span><span class="p">].</span><span class="nx">src</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'star_border_white'</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">break</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">track</span><span class="p">.</span><span class="nx">rating</span> <span class="o">=</span> <span class="nx">stars</span> <span class="o">/</span> <span class="mf">5.0</span>
    <span class="p">}</span>

  <span class="nx">player</span><span class="p">.</span><span class="nx">setTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">)</span>

  <span class="p">...</span>

  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">...</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">setCanRate</span><span class="p">(</span><span class="nx">state</span> <span class="o">!==</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="c1">// Handler for rating</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onRatingSet</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">rating</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">stars</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">stars</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_setRating</span><span class="p">(</span><span class="nx">stars</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_setRating</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'rating-change'</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">elm</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">stars</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Click on the current star to erase it</span>
      <span class="kd">var</span> <span class="nx">rating</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'rating'</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">stars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">stars</span> <span class="o">&lt;</span> <span class="nx">rating</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">stars</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">rating</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">stars</span><span class="p">].</span><span class="nx">src</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'star_border_white'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">break</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">stars</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">stars</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nx">elm</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">stars</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>
</pre></div>
<p><img alt="Track Rating" src="../images/guide/track_rating.png"/></p>
<h3 id="custom-actions">Custom Actions</h3>
<p>Service integrations can also create <a href="../apps/custom-actions.html">custom Actions</a> like <strong>thumbs up/down</strong>,
<strong>star rating</strong> or whatever might be useful. These actions are typically exported as menu items of a tray icon or
a dock item, or can have a keyboard shortcut:</p>
<p><img alt="Custom actions in AppIndicators" src="../images/guide/example_gnome_appindicator_custom_actions.png"/>
<img alt="Custom actions in Pantheon dock" src="../images/guide/example_pantheon_dock_custom_actions.png"/>
<img alt="Custom actions in Unity launcher" src="../images/guide/example_unity_launcher_custom_actions.png"/>
<img alt="Custom actions in keybindings" src="../images/guide/example_keybindings_custom_actions.png"/></p>
<p>Let's enhance our current integration of track rating with custom actions for that:</p>
<div class="codehilite"><pre><span></span><span class="p">...</span>
<span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">$object</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">MediaPlayer</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">Translate</span><span class="p">.</span><span class="nx">gettext</span>
<span class="p">...</span>
<span class="c1">// Define rating options - 5 states with state id 0-5 representing 0-5 stars</span>
<span class="kd">var</span> <span class="nx">ratingOptions</span> <span class="o">=</span> <span class="p">[</span>
  <span class="c1">// stateId, label, mnemo_label, icon, keybinding</span>
  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 0 stars'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 1 star'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 2 stars'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 3 stars'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 4 stars'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
  <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="nx">_</span><span class="p">(</span><span class="s1">'Rating: 5 stars'</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">]</span>
<span class="p">]</span>
<span class="c1">// Add new radio action named `rating` with initial state `3` (3 stars)</span>
<span class="kd">var</span> <span class="nx">ACTION_RATING</span> <span class="o">=</span> <span class="s1">'rating'</span>
<span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">addRadioAction</span><span class="p">(</span><span class="s1">'playback'</span><span class="p">,</span> <span class="s1">'win'</span><span class="p">,</span> <span class="nx">ACTION_RATING</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">ratingOptions</span><span class="p">)</span>


<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Add extra actions</span>
  <span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ACTION_RATING</span> <span class="o">+</span> <span class="s1">'::'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">player</span><span class="p">.</span><span class="nx">addExtraActions</span><span class="p">(</span><span class="nx">actions</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">stars</span> <span class="o">=</span> <span class="p">...</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">...</span>
  <span class="p">...</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateEnabledFlag</span><span class="p">(</span><span class="nx">ACTION_RATING</span><span class="p">,</span> <span class="nx">state</span> <span class="o">!==</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">)</span>
  <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">ACTION_RATING</span><span class="p">,</span> <span class="nx">stars</span><span class="p">)</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="nx">ACTION_RATING</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_setRating</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Custom actions" src="../images/guide/custom_actions.png"/></p>
    <div class="footer">
  <hr />
  <div class="panel panel-primary">
    <p class="panel-heading">
      Questions? Feedback?
    </p>
    <div class="panel-body">
      <p>
        Having trouble? We'd like to help!
      </p>
      <ul>
        <li>Search for information in the archives of
          <a href="https://groups.google.com/d/forum/nuvola-player-devel">the nuvola-player-devel
          mailing list</a>, or post a question.
        </li>
        <li>
          If you notice errors with this documentation, please
          <a href="https://github.com/tiliado/nuvolaplayer/issues">open a ticket and let us
          know</a>! Please only use the ticket tracker for criticisms and improvements on the docs.
        </li>
      </ul>
    </div>
  </div>
  <hr />
  <p class="text-center">
    Generated by <a href="http://getpelican.com/">Pelican</a>.
    Get <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">source code</a>.
    Uses <a href="http://getbootstrap.com/">Bootstrap</a> theme
    <a href="http://bootswatch.com/united/">United</a>.
  </p>
</div>
  </div> 

      </div>
    </div>
  </body>
</html>
