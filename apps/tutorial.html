<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Service Integrations Tutorial</title>
    <link rel="stylesheet" href="../theme/bootstrap.min.css" />
    <link rel="stylesheet" href="../theme/pygments.css" />
    <link rel="stylesheet" href="../theme/main.css" />
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="../theme/jquery.min.js"></script>
    <script src="../theme/bootstrap.min.js"></script>
  </head>
  <body>
<nav class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
<a class="navbar-brand" href="../index.html">Nuvola Player Development</a>    </div><!-- .navbar-header -->

<div class="collapse navbar-collapse" id="navbar-collapse-1">
  <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../core.html">Core</a></li>
            <li class="dropdown">
              <a href="../apps.html" class="dropdown-toggle" data-toggle="dropdown">Service Integrations <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="../apps.html">Introduction</a></li>
                <li><a href="../apps/porting.html">Porting to Nuvola Player 3</a></li>
                <li><a href="../apps/api_reference.html">NuvolaKit 3.0 JavaScript API Reference</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Basic</li>
                <li><a href="../apps/tutorial.html">Service Integration Tutorial</a></li>
                <li><a href="../apps/guidelines.html">Service Integration Guidelines</a></li>
                <li><a href="../apps/distribute.html">Distribute Service Integration</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Advanced</li>
                <li><a href="../apps/guide.html">Full Service Integration Guide</a></li>
                <li><a href="../apps/url-filtering.html">URL Filtering (URL Sandbox)</a></li>
                <li><a href="../apps/configuration-and-session-storage.html">Configuration and session storage</a></li>
                <li><a href="../apps/initialization-and-preferences-forms.html">Initialization and Preferences Forms</a></li>
                <li><a href="../apps/variable-home-page-url.html">Web apps with a variable home page URL</a></li>
                <li><a href="../apps/custom-actions.html">Custom Actions</a></li>
                <li><a href="../apps/translations.html">Translations</a></li>
              </ul>
            </li>
          </ul>
</div><!-- .navbar-collapse -->  </div>
</nav>    
    <div class="container">
      <div class="row">
        
  <div class="col-sm-12">
      <div class="page-header text-center">
        <h1 id="top">Service Integrations Tutorial</h1>
      </div>
  </div>
  <div class="col-md-2 col-lg-3 sidebar">
      <p><strong>Contents</strong></p>
      <div class="toc">
<ul>
<li><a href="#prepare-development-environment">Prepare development environment</a></li>
<li><a href="#create-metadata-file">Create metadata file</a></li>
<li><a href="#create-integration-script">Create integration script</a></li>
<li><a href="#launch-nuvola-player">Launch Nuvola Player</a></li>
<li><a href="#debugging-and-logging-messages">Debugging and logging messages</a></li>
<li><a href="#playback-state-and-track-details">Playback state and track details</a><ul>
<li><a href="#playback-state">Playback state</a></li>
<li><a href="#track-details">Track details</a></li>
</ul>
</li>
<li><a href="#player-actions">Player Actions</a></li>
<li><a href="#what-to-do-next">What to do next</a></li>
</ul>
</div>
<p><strong>Download documentation</strong></p>

<p>You can download the whole documentation in HTML format as</p>
<ul>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc/archive/master.zip">Zip Archive</a></li>
  <li><a href="https://github.com/tiliado/nuvolaplayer-developer-doc">Git Repository</a></li>
</ul>

<p><strong>Get source</strong></p>
<p>
  This documentation is built from the
  <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">doc directory</a>
  of the
  <a href="https://github.com/tiliado/nuvolaplayer">Nuvola Player repository</a>.
</p>    <span class="backtotop"><a href="#top">↑ Back to top ↑</a></span>
  </div>
  <div class="col-sm-12 col-md-10 col-lg-9">
    
<p>This tutorial briefly describes creation of <strong>a new service integration for Nuvola Player 3 from
scratch</strong>. The goal is to write an integration script for <em>fake Happy Songs  service</em> shipped with
Nuvola Player and to prepare you to create your own service integration.
I'm looking forward to a code review ;-)
There is also more detailed <a href="../apps/guide.html">Service Integrations Guide</a> that provides
insight to the NuvolaKit core. </p>
<h2 id="prepare-development-environment">Prepare development environment</h2>
<ol>
<li>Install Nuvola Player 3</li>
<li>
<p>Create a project directory <code>~/projects/nuvola-player</code> (or any other name, but don't forget to
    adjust paths in this tutorial).</p>
<div class="codehilite"><pre>mkdir -p ~/projects/nuvola-player
</pre></div>
</li>
<li>
<p>Create a copy of the template shipped with Nuvola Player 3.</p>
<div class="codehilite"><pre>cd ~/projects/nuvola-player
cp -r /usr/share/nuvolaplayer3/web_apps/template ./happy-songs
# or
cp -r /usr/local/share/nuvolaplayer3/web_apps/template ./happy-songs
</pre></div>
</li>
<li>
<p>Create new integration files and open them in your preferred plan-text editor (Gedit,
    for example).</p>
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
touch metadata.json integrate.js
gedit metadata.json integrate.js &gt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</pre></div>
</li>
<li>
<p>Initialize a new <a href="http://git-scm.com/">Git</a> repository for your service integration.</p>
<p>You can skip this step if you don't know <a href="http://git-scm.com/">Git version control system</a>. However, if you
would like to have your service integration maintained as a part of the Nuvola Player project
and available in the Nuvola Player repository, you will increase maintenance burden of the
project, because somebody (<a href="http://fenryxo.cz"><em>me</em></a>) will have to create Git repository from tar.gz archive of your
service integration anyway.</p>
<p>If you are not familiar with the <a href="http://git-scm.com/">Git version control system</a>,
you can check <a href="https://try.github.io/levels/1/challenges/1">Git tutorial</a>
and <a href="http://git-scm.com/book">Pro Git Book</a>.</p>
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
git init .
git add metadata.json integrate.js
git commit -m <span class="s2">"Initial commit"</span>
</pre></div>
</li>
</ol>
<h2 id="create-metadata-file">Create metadata file</h2>
<p><strong>Metadata file contains basic information about your service integrations.</strong> It uses
<a href="http://en.wikipedia.org/wiki/JSON">JSON format</a> and it's called <code>metadata.json</code>.
Let's look at the example:</p>
<div class="codehilite"><pre><span class="p">{</span>
    <span class="nt">"id"</span><span class="p">:</span> <span class="s2">"happy_songs"</span><span class="p">,</span>
    <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Happy Songs"</span><span class="p">,</span>
    <span class="nt">"maintainer_name"</span><span class="p">:</span> <span class="s2">"Jiří Janoušek"</span><span class="p">,</span>
    <span class="nt">"maintainer_link"</span><span class="p">:</span> <span class="s2">"https://github.com/fenryxo"</span><span class="p">,</span>
    <span class="nt">"version_major"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">"version_minor"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">"api_major"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">"api_minor"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">"categories"</span><span class="p">:</span> <span class="s2">"AudioVideo;Audio;"</span><span class="p">,</span>
    <span class="nt">"home_url"</span><span class="p">:</span> <span class="s2">"nuvola://home.html"</span>
<span class="p">}</span>
</pre></div>
<p>This file contains several mandatory fields:</p>
<dl>
<dt><code>id</code></dt>
<dd>
<p>Identifier of the service. It can contain only letters <code>a-z</code>, digits <code>0-9</code> and underscore <code>_</code> to
separate words, e.g. <code>google_play_music</code> for Google Play Music, <code>8tracks</code> for 8tracks.com.
(Nuvola Player 2 required the id must be same as the directory name of the service
integration, but Nuvola Player 3 doesn't have this limitation.)</p>
</dd>
<dt><code>name</code></dt>
<dd>
<p>Name of the service (for humans), e.g. "Google Play Music".</p>
</dd>
<dt><code>version_major</code></dt>
<dd>
<p>Major version of the integration, must be an integer &gt; 0. You should use
<code>1</code> for an initial version. This number is increased, when a major change occurs.</p>
</dd>
<dt><code>version_minor</code></dt>
<dd>
<p>A minor version of service integration, an integer &gt;= 0. This field should
be increased when a new release is made.</p>
</dd>
<dt><code>maintainer_name</code></dt>
<dd>
<p>A name of the maintainer of the service integration.</p>
</dd>
<dt><code>maintainer_link</code></dt>
<dd>
<p>A link to a page with contact to maintainer (including <code>http://</code> or <code>https://</code>) or an email
address prefixed by <code>mailto:</code>.</p>
</dd>
<dt><code>api_major</code> and <code>api_minor</code></dt>
<dd>
<p>A required version of JavaScript API, currently <code>3.0</code>.</p>
</dd>
<dt><code>categories</code></dt>
<dd>
<p><a href="http://standards.freedesktop.org/menu-spec/latest/apa.html">Application categories</a> suitable
for the web app. It is used to place a desktop launcher to proper category in applications menu.
Nuvola Player services should be in <code>"AudioVideo;Audio;"</code>.</p>
</dd>
<dt><code>home_url</code></dt>
<dd>
<p>Home page of your service. The template contains fake service home page <code>home.html</code>, which
has a special address <code>nuvola://home.html</code>. You will use a real homepage later in your own
service integration (e.g. <code>https://play.google.com/music/</code> for Google Play Music).</p>
<p>This field is not required if you use custom function to handle home page request.
See <a href="../apps/variable-home-page-url.html">Web apps with a variable home page URL</a>.</p>
</dd>
</dl>
<p>This file can include also optional fields:</p>
<dl>
<dt><code>window_width</code>, <code>window_height</code></dt>
<dd>
<p>Suggested window width or height in pixels.</p>
</dd>
</dl>
<div class="panel panel-danger"><p class="panel-heading">Extra rules for metadata.json</p><div class="panel-body">
<p>If you want to have your integration script maintained and distributed as a part of the Nuvola
Player project, you have to follow rules in <a href="../apps/guidelines.html">Service Integrations Guidelines</a>.</p>
</div></div>
<div class="panel panel-info"><p class="panel-heading">If you use Git, commit changes</p><div class="panel-body">
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
git add metadata.json
git commit -m <span class="s2">"Add initial metadata for service"</span>
</pre></div>
</div></div>
<h2 id="create-integration-script">Create integration script</h2>
<p><strong>The integration script is the fundamental part of the service integration.</strong> It's written in
JavaScript and called <code>integrate.js</code>. This script is called once at start-up of the web app to
perform initialization of the main process (covered in <a href="../apps/guide.html">the guide</a>) and again
in the web page rendering process every-time a web page is loaded in the web view. Let's look at the
next sample integration script that doesn't actually do much, but will be used as a base for further
modifications.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="codehilite"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2015 Your name &lt;your e-mail&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met: </span>
<span class="cm"> * </span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm"> *    list of conditions and the following disclaimer. </span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm"> *    this list of conditions and the following disclaimer in the documentation</span>
<span class="cm"> *    and/or other materials provided with the distribution. </span>
<span class="cm"> * </span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="cm"> * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<span class="cm"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="cm"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="cm"> * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="s2">"use strict"</span><span class="p">;</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">)</span>
<span class="p">{</span>

<span class="c1">// Create media player component</span>
<span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">$object</span><span class="p">(</span><span class="nx">Nuvola</span><span class="p">.</span><span class="nx">MediaPlayer</span><span class="p">);</span>

<span class="c1">// Handy aliases</span>
<span class="kd">var</span> <span class="nx">PlaybackState</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlaybackState</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">PlayerAction</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerAction</span><span class="p">;</span>

<span class="c1">// Create new WebApp prototype</span>
<span class="kd">var</span> <span class="nx">WebApp</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">$WebApp</span><span class="p">();</span>

<span class="c1">// Initialization routines</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onInitWebWorker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">emitter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onInitWebWorker</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">emitter</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s2">"interactive"</span> <span class="o">||</span> <span class="nx">state</span> <span class="o">===</span> <span class="s2">"complete"</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_onPageReady</span><span class="p">();</span>
    <span class="k">else</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"DOMContentLoaded"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_onPageReady</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Page is ready for magic</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Connect handler for signal ActionActivated</span>
    <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">"ActionActivated"</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="c1">// Start update routine</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Extract data from the web page</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">track</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">artist</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">album</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">artLocation</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">}</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">setTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">);</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setPlaybackState</span><span class="p">(</span><span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">);</span>

    <span class="c1">// Schedule the next update</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Handler of playback actions</span>
<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

<span class="p">})(</span><span class="k">this</span><span class="p">);</span>  <span class="c1">// function(Nuvola)</span>
</pre></div>
</td></tr></table>
<dl>
<dt>Lines 2-22</dt>
<dd>
<p>Copyright and license information. While you can choose any license for your work, it's
recommended to use the license of Nuvola Player as shown in the example.</p>
</dd>
<dt>Line 25</dt>
<dd>
<p>Use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode">strict JavaScript mode</a> in your scripts.</p>
</dd>
<dt>Lines 27-28 and 86</dt>
<dd>
<p>Use <a href="http://markdalgleish.com/2011/03/self-executing-anonymous-functions/">self-executing anonymous function</a> to create closure with <a href="./api_reference.html#">Nuvola object</a>.
(Integration script are executed with <code>Nuvola</code> object bound to <code>this</code>).</p>
</dd>
<dt>Line 31</dt>
<dd>
<p>Create <a href="./api_reference.html#Nuvola.MediaPlayer">MediaPlayer</a> component that adds playback actions and is later used to provide playback
details.</p>
</dd>
<dt>Line 38</dt>
<dd>
<p>Create new WebApp prototype object derived from the <a href="./api_reference.html#Nuvola.WebApp">Nuvola.WebApp</a> prototype that contains
handy default handlers for initialization routines and signals from Nuvola core. 
You can override them if your web app requires more magic ;-)</p>
</dd>
<dt>Lines 41-50</dt>
<dd>
<p>Handler for <a href="./api_reference.html#Core%3A%3AInitWebWorker">Nuvola.Core::InitWebWorker signal</a> signal that
emitted in clear JavaScript environment with a brand new global <code>window</code> object. You should
not touch it, only perform necessary initialization (usually not needed) and set your listener
for either <code>document</code>'s <code>DOMContentLoaded</code> event (preferred) or <code>window</code>'s <code>load</code> event.</p>
</dd>
<dt>Lines 53-60</dt>
<dd>
<p>When document object model of a web page is ready, we register a signal handler for playback
actions and call update() method.</p>
</dd>
<dt>Lines 63-77</dt>
<dd>
<p>The update() method periodically extracts playback state and track details.</p>
</dd>
<dt>Lines 81-82</dt>
<dd>
<p>Actions handler is used to respond to player actions.</p>
</dd>
<dt>Line 84</dt>
<dd>
<p>Convenience method to create and register new instance of your web app integration.</p>
</dd>
</dl>
<div class="panel panel-info"><p class="panel-heading">If you use Git, commit changes</p><div class="panel-body">
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
git add integrate.js
git commit -m <span class="s2">"Add skeleton of integration script"</span>
</pre></div>
</div></div>
<h2 id="launch-nuvola-player">Launch Nuvola Player</h2>
<p>Run Nuvola Player 3 from terminal with following command and you will see a list with only one
service Happy Songs, because we told Nuvola Player to load service integrations only from directory
<code>~/projects/nuvola-player</code>.</p>
<div class="codehilite"><pre><span class="nv">$ </span>nuvolaplayer3 -D -A ~/projects/nuvola-player
...
<span class="o">[</span>Master:DEBUG    Nuvola<span class="o">]</span> WebAppRegistry.vala:128: Found web app Happy Songs at /home/fenryxo/projects/nuvola-player/happy-songs, version 1.0
...
</pre></div>
<div class="panel panel-danger"><p class="panel-heading">Make sure all Nuvola Player instances have been closed</p><div class="panel-body">
<p>If you see following warning in terminal, there is a running instance of Nuvola Player
that must be closed. Otherwise, the <code>-A</code> parameter is ignored.</p>
<div class="codehilite"><pre>[Master:INFO     Nuvola] master.vala:135: Nuvola Player 3 Beta instance is already running
and will be activated.
[Master:WARNING  Nuvola] master.vala:137: Some command line parameters (-D, -v, -A, -L) are
ignored because they apply only to a new instance. You might want to close all Nuvola Player
instances and run it again with your parameters.
</pre></div>
</div></div>
<p><img alt="A list with single service integration" src="../images/guide/app_list_one_service.png"/></p>
<p>Launch your service integration and a new window will be opened with the test service. First of all,
show <strong>developer's sidebar</strong> (Gear menu → Show sidebar → select "Developer" in the right 
sidebar), then enable <strong>WebKit Web Inspector</strong> (right-click the web page anywhere and select
"Inspect element").</p>
<p><img alt="Show sidebar - GNOME Shell" src="../images/guide/show_sidebar_gnome_shell.png"/></p>
<p><img alt="Inspect element" src="../images/guide/inspect_element.png"/></p>
<p><img alt="WebKit Web Inspector" src="../images/guide/webkit_web_inspector.png"/></p>
<p>You can also launch your service integration with id <code>happy_songs</code> directly.</p>
<div class="codehilite"><pre>nuvolaplayer3 -D -A ~/projects/nuvola-player -a happy_songs
</pre></div>
<h2 id="debugging-and-logging-messages">Debugging and logging messages</h2>
<p>You might want to print some debugging messages to console during development. There are two types
of them in Nuvola Player:</p>
<ul>
<li><strong>JavaScript console</strong> is shown in the WebKit Web Inspector.</li>
<li><strong>Terminal console</strong> is the black window with white text. Debugging messages are only printed
    if you have launched Nuvola Player with <code>-D</code> or <code>--debug</code> flag.</li>
</ul>
<p>The are two ways how to print debugging messages:</p>
<ul>
<li><a href="./api_reference.html#Nuvola.log">Nuvola.log()</a> always prints only to terminal console.</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/console.log">console.log()</a> prints to JavaScript
    console only if <a href="https://developer.mozilla.org/en/docs/Web/API/Window">Window object</a> is
    the the global object of the current JavaScript environment. Otherwise, Nuvola.log is used as a
    fallback and a warning is issued.</li>
</ul>
<p>You might be wondering <strong>why the Window object isn't always available as the global JavaScript
object</strong>. That's because Nuvola Player executes a lot of JavaScript code in a pure JavaScript
environment outside the web view. However, the <a href="./api_reference.html#Core%3A%3AInitWebWorker">Core::InitWebWorker signal</a>
and your <code>WebApp._onInitWebWorker</code> and <code>WebApp._onActionActivated</code> signal handlers are
invoked in the web view with the global window object, so feel free to use <code>console.log()</code>.</p>
<h2 id="playback-state-and-track-details">Playback state and track details</h2>
<p>The first task of your service integration is to <strong>extract playback state and track details from the
web page</strong> and provide them to the media player component. There are two ways how to extract playback
state and track details:</p>
<ol>
<li>Use <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model">Document Object Model</a> to get information from the HTML code of the web page.</li>
<li>Use JavaScript API provided by the web page if there is any.</li>
</ol>
<p>The first way is more general and will be described here. The folowing methods are useful:</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementById">document.getElementById</a> -
    look-up an element by <code>id</code> attribute</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document.getElementsByName">document.getElementsByName</a> -
    look-up elements by <code>name</code> attribute</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementsByClassName">document.getElementsByClassName</a> -
    look-up elements by <code>class</code> attribute</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/document.getElementsByTagName">document.getElementsByTagName</a> -
    look-up elements by tag name (e.g. <code>a</code>, <code>div</code>, etc.)</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/document.querySelector">document.querySelector</a> -
    look-up the first element that matches provided <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Getting_Started/Selectors">CSS selector</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/document.querySelectorAll">document.querySelectorAll</a> -
    look-up all elements that match provided <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Getting_Started/Selectors">CSS selector</a></li>
</ul>
<h3 id="playback-state">Playback state</h3>
<p>Looking at the code of a web page shown in the picture bellow, the code to extract playback state
might be. Playback states are defined in an enumeration
<a href="./api_reference.html#Nuvola.PlaybackState">Nuvola.PlaybackState</a> and set by method
<a href="./api_reference.html#Nuvola.MediaPlayer.setPlaybackState">player.setPlaybackState()</a>.</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">PlaybackState</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlaybackState</span><span class="p">;</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"status"</span><span class="p">).</span><span class="nx">innerText</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="s2">"Playing"</span><span class="o">:</span>
                <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">"Paused"</span><span class="o">:</span>
                <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Always expect errors, e.g. document.getElementById("status") might be null</span>
        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">PlaybackState</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">setPlaybackState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Playback state" src="../images/guide/playback_state.png"/></p>
<h3 id="track-details">Track details</h3>
<p>Similarly, we can obtain track details and pass them to method <a href="./api_reference.html#Nuvola.MediaPlayer.setTrack">player.setTrack()</a></p>
<div class="codehilite"><pre><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">var</span> <span class="nx">track</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">artLocation</span><span class="o">:</span> <span class="kc">null</span> <span class="c1">// always null</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">idMap</span> <span class="o">=</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s2">"track"</span><span class="p">,</span> <span class="nx">artist</span><span class="o">:</span> <span class="s2">"artist"</span><span class="p">,</span> <span class="nx">album</span><span class="o">:</span> <span class="s2">"album"</span><span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">idMap</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="nx">track</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">idMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]).</span><span class="nx">innerText</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Always expect errors, e.g. document.getElementById() might return null</span>
            <span class="nx">track</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">player</span><span class="p">.</span><span class="nx">setTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">);</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Track details" src="../images/guide/track_details.png"/></p>
<div class="panel panel-info"><p class="panel-heading">If you use Git, commit changes</p><div class="panel-body">
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
git add integrate.js
git commit -m <span class="s2">"Extract metadata and playback state"</span>
</pre></div>
</div></div>
<h2 id="player-actions">Player Actions</h2>
<p>The second responsibility of a service integration is to <strong>manage media player actions</strong>:</p>
<ol>
<li>Set which actions are enabled.</li>
<li>Invoke the actions when they are activated.</li>
</ol>
<p>The first part is done via calls <a href="./api_reference.html#Nuvola.MediaPlayer.setCanPause">player.setCanPause()</a>,
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanPlay">player.setCanPlay()</a>,
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanGoPrev">player.setCanGoPrev()</a> and
<a href="./api_reference.html#Nuvola.MediaPlayer.setCanGoNext">player.setCanGoNext()</a>:</p>
<div class="codehilite"><pre><span class="nx">WebApp</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">var</span> <span class="nx">enabled</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="nx">enabled</span> <span class="o">=</span> <span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"prev"</span><span class="p">).</span><span class="nx">disabled</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setCanGoPrev</span><span class="p">(</span><span class="nx">enabled</span><span class="p">);</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="nx">enabled</span>  <span class="o">=</span> <span class="o">!</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"next"</span><span class="p">).</span><span class="nx">disabled</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setCanGoNext</span><span class="p">(</span><span class="nx">enabled</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">playPause</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"pp"</span><span class="p">);</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="nx">enabled</span>  <span class="o">=</span> <span class="nx">playPause</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">==</span> <span class="s2">"Play"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setCanPlay</span><span class="p">(</span><span class="nx">enabled</span><span class="p">);</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="nx">enabled</span>  <span class="o">=</span> <span class="nx">playPause</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">==</span> <span class="s2">"Pause"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">player</span><span class="p">.</span><span class="nx">setCanPause</span><span class="p">(</span><span class="nx">enabled</span><span class="p">);</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
<p><img alt="Playback actions" src="../images/guide/playback_actions.png"/></p>
<p>To handle playback actions defined in an enumeration <a href="./api_reference.html#Nuvola.PlayerAction">PlayerAction</a>,
it is necessary to connect to <a href="./api_reference.html#Nuvola.Actions%3A%3AActionActivated">Actions::ActionActivated signal</a>.
You can use a convenient function <a href="./api_reference.html#Nuvola.clickOnElement">Nuvola.clickOnElement()</a> to
simulate clicking.</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">PlayerAction</span> <span class="o">=</span> <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">PlayerAction</span><span class="p">;</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onPageReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Connect handler for signal ActionActivated</span>
    <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">"ActionActivated"</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="c1">// Start update routine</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">WebApp</span><span class="p">.</span><span class="nx">_onActionActivated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">emitter</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">TOGGLE_PLAY</span><span class="o">:</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PLAY</span><span class="o">:</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PAUSE</span><span class="o">:</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">STOP</span><span class="o">:</span>
        <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"pp"</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">PREV_SONG</span><span class="o">:</span>
        <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"prev"</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nx">PlayerAction</span><span class="p">.</span><span class="nx">NEXT_SONG</span><span class="o">:</span>
        <span class="nx">Nuvola</span><span class="p">.</span><span class="nx">clickOnElement</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"next"</span><span class="p">));</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="panel panel-danger"><p class="panel-heading">Always test playback actions</p><div class="panel-body">
<p>You should click action buttons in the developer's sidebar to be sure they are working as expected.</p>
</div></div>
<div class="panel panel-info"><p class="panel-heading">If you use Git, commit changes</p><div class="panel-body">
<div class="codehilite"><pre><span class="nb">cd</span> ~/projects/nuvola-player/happy-songs
git add integrate.js
git commit -m <span class="s2">"Add player actions handling"</span>
</pre></div>
</div></div>
<div class="panel panel-info"><p class="panel-heading">Custom actions</p><div class="panel-body">
<p>Service integrations can also create <a href="../apps/custom-actions.html">custom Actions</a> like thumbs
up/down or star rating.</p>
</div></div>
<h2 id="what-to-do-next">What to do next</h2>
<p>If you would like to have your service integration <strong>maintained as a part of Nuvola
Player project</strong> and distributed in Nuvola Player repository, you have to follow
<a href="../apps/guidelines.html">Service Integration Guidelines</a>. Once you have <strong>finished your
service integration</strong>, the next step is to <a href="../apps/distribute.html">distribute</a> it.</p>
<p>Supposing you have followed this tutorial, you have enough knowledge to create your own service
integration. You are encouraged to take a look at articles in advanced section to spice up your work:</p>
<ul>
<li><a href="../apps/guide.html">Full Service Integration Guide</a>: This guide describes creation of a new service
    integration for Nuvola Player 3 from scratch in a much detail, provides <strong>insight to the Nuvola
    Player Core</strong> and explain some design decisions.</li>
<li><a href="../apps/url-filtering.html">URL Filtering (URL Sandbox)</a>:
    Decide which urls are opened in a default web browser instead of Nuvola Player.</li>
<li><a href="../apps/configuration-and-session-storage.html">Configuration and session storage</a>:
    Nuvola Player 3 allows service integrations to store both a persistent configuration and a temporary session information.</li>
<li><a href="../apps/initialization-and-preferences-forms.html">Initialization and Preferences Forms</a>:
    These forms are useful when you need to get user input.</li>
<li><a href="../apps/variable-home-page-url.html">Web apps with a variable home page URL</a>:
    This article covers Web apps that don't have a single (constant) home page URL, so their home page has to be specified by user.</li>
<li><a href="../apps/custom-actions.html">Custom Actions</a>:
    This article covers API that allows you to add custom actions like thumbs up/down rating.</li>
<li><a href="../apps/translations.html">Translations</a>: How to mark translatable strings for 
    <a href="http://www.gnu.org/software/gettext/manual/gettext.html">Gettext-based</a>
    translations framework for service integration scripts.</li>
</ul>
<div class="footer">
  <hr />
  <div class="panel panel-primary">
    <p class="panel-heading">
      Questions? Feedback?
    </p>
    <div class="panel-body">
      <p>
        Having trouble? We'd like to help!
      </p>
      <ul>
        <li>Search for information in the archives of
          <a href="https://groups.google.com/d/forum/nuvola-player-devel">the nuvola-player-devel
          mailing list</a>, or post a question.
        </li>
        <li>
          If you notice errors with this documentation, please
          <a href="https://github.com/tiliado/nuvolaplayer/issues">open a ticket and let us
          know</a>! Please only use the ticket tracker for criticisms and improvements on the docs.
        </li>
      </ul>
    </div>
  </div>
  <hr />
  <p class="text-center">
    Generated by <a href="http://getpelican.com/">Pelican</a>.
    Get <a href="https://github.com/tiliado/nuvolaplayer/tree/master/doc">source code</a>.
    Uses <a href="http://getbootstrap.com/">Bootstrap</a> theme
    <a href="http://bootswatch.com/united/">United</a>.
  </p>
</div>  </div> 
      </div>
    </div>
  </body>
</html>
